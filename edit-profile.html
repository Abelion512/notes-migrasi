<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Edit Profile â€“ Abelion Notes</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --blue1: #2f88ff;
      --blue2: #7fd7ff;
      --blue3: #a0bbff;
      --blue-bg: #252f46;
      --blue-card: #6cadf9;
      --blue-grad: linear-gradient(120deg, #43c6ff 0%, #6cadf9 100%);
      --blue-grad-dark: linear-gradient(120deg, #2f88ff 0%, #354d7f 100%);
      --footer-height: 56px;
      --border-radius: 36px;
      --shadow: 0 8px 38px #2f88ff28, 0 1.5px 8px #0002;
      --btn-radius: 18px;
      --font-main: 'Inter', Arial, sans-serif;
    }
    html, body {
      background: var(--blue-bg);
      min-height: 100vh;
      font-family: var(--font-main);
      color: #fff;
      padding: 0; margin: 0;
      height: 100%;
    }
    .container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      height: 100vh;
      background: var(--blue-bg);
    }
    .card {
      background: var(--blue-card);
      width: 100%;
      max-width: 410px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      padding: 36px 20px 84px 20px;
      text-align: center;
      margin: 44px 0 18px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      min-height: calc(100vh - 120px);
      z-index: 2;
      overflow: visible;
    }
    .nav-head {
      position: absolute; top: 18px; left: 0; right: 0;
      display: flex; justify-content: space-between; align-items:center; z-index:5;
      padding: 0 18px;
    }
    .nav-btn, .nav-info-btn {
      background: var(--blue-grad-dark);
      color: #fff; border: none;
      border-radius: 15px; padding: 7px 20px; font-weight: 700; font-size: 1em;
      cursor: pointer; outline: none; margin:0 2px; box-shadow:0 1.5px 8px #2f88ff18;
      transition: filter .14s;
      font-family: var(--font-main);
      letter-spacing: .01em;
    }
    .avatar { width: 102px; height: 102px; background: #d0eaff; border-radius:50%; margin:0 auto 13px; object-fit:cover; box-shadow: 0 2px 14px #2f88ff33; border: 4px solid #fff;}
    .avatar.empty { background: #eee; border: 4px solid #b2ceea;}
    .edit-photo-label {
      display:block; color: #2f88ff; background: #fff; font-weight:700;
      border-radius: 99px; padding:9px 27px; font-size:1.12em; margin:0 auto 20px auto;
      box-shadow:0 1px 5px #6cadf953;
      cursor:pointer;
      transition: filter .13s;
    }
    .edit-photo-label:hover { filter:brightness(0.97);}
    .form-label {
      text-align:left; font-weight:700; font-size:1.04em; color:#1b3556;
      margin-bottom: 7px; margin-top: 15px; display: block;
    }
    .input, .textarea {
      width: 100%; max-width: 320px;
      padding: 11px; border-radius: 10px; border: 1.5px solid #5ecbff;
      background: #e8f3fc;
      margin-bottom: 18px; color: #222; font-size: 1.07em;
      font-family: var(--font-main);
      font-weight: 600;
    }
    .input:focus, .textarea:focus { border-color: #2f88ff;}
    .desc {
      font-size: 1.07em; color: #1b3556; margin: 15px 0 32px 0; text-align: left;
      max-width: 330px;
    }
    .desc small { color:#3b5a9b;}
    .badge-row {
      display: flex; gap: 13px; justify-content:center; margin: 17px 0 19px 0;
    }
    .badge-box {
      width:43px; height:43px; background:#e3e8f5;
      border-radius: 13px; display:flex; align-items:center; justify-content:center;
      font-size:1.36em; color:#458bfd;
      border:2px solid #c1cffe;
      font-weight: 700;
      cursor: pointer;
      transition: box-shadow .13s, border .13s, background .13s;
    }
    .badge-box--active { border:2px solid #ffd800; background: #fffae6; }
    .btn-row {
      display:flex; gap:18px; justify-content:center; margin:41px 0 0 0;
      width:100%; max-width:340px;
    }
    .btn {
      background: var(--blue-grad); color:#fff; border:none;
      border-radius: var(--btn-radius);
      font-size:1.04em; font-weight:700;
      padding:13px 0; width:100%; min-width:133px;
      box-shadow:0 1.5px 8px #39b2ff18;
      cursor:pointer; transition:filter .14s;
      font-family: var(--font-main);
    }
    .btn:active { filter:brightness(0.96);}
    .footer {
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: var(--footer-height);
      line-height: var(--footer-height);
      background: transparent;
      text-align: center;
      z-index: 10;
      pointer-events: none;
      user-select: none;
      font-weight: 500;
      font-size:1.03em;
      color:#e6f7ff;
      letter-spacing: 0.01em;
    }
    @media (max-width: 540px){
      .card { padding: 12px 2vw 85px 2vw; max-width: 99vw; border-radius: 19px; }
      .btn-row{ max-width: 99vw; flex-direction: column; gap: 13px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="nav-head">
        <button class="nav-btn" onclick="window.history.back()">&lt; Back</button>
        <button class="nav-info-btn" onclick="window.location.href='version-info.html'">Version info</button>
      </div>
      <img src="" alt="Foto Profil" class="avatar empty" id="profile-avatar"/>
      <label class="edit-photo-label" for="photo-input">Edit photo</label>
      <input type="file" accept="image/*" id="photo-input" style="display:none"/>
      <label class="form-label" for="username">Username:</label>
      <input class="input" type="text" id="username" placeholder="input your username"/>
      <div class="desc">
        Pilih Title (Badge/Rank aktif) yang ingin ditampilkan di profile<br>
        <br>
        <small>â€¢ Link Sosial user (IG, GitHub, dll)</small>
      </div>
      <div class="badge-row">
        <div class="badge-box badge-box--active">ðŸªœ</div>
        <div class="badge-box">ðŸŒ¿</div>
        <div class="badge-box">ðŸ”§</div>
        <div class="badge-box"></div>
      </div>
      <div class="btn-row">
        <button class="btn" style="background:#fff;color:#2f88ff;font-weight:700;" onclick="resetProfile()">reset profile</button>
        <button class="btn" onclick="saveProfile()">save profile</button>
      </div>
      <div class="footer">
        Â© 2025 Abelion Notes. All rights reserved.
      </div>
    </div>
  </div>
  <script src="utils.js"></script>
  <script>
    const { STORAGE_KEYS, sanitizeText, safeGetItem, safeSetItem } = AbelionUtils;

    const DEFAULT_PROFILE = {
      name: 'Abelion',
      photo: '',
      level: 3,
      xp: 52,
      title: 'Explorer',
      badges: ['ðŸªœ','ðŸŒ¿','ðŸ”§',''],
      activeBadge: 'ðŸªœ'
    };

    function loadProfile() {
      const stored = safeGetItem(STORAGE_KEYS.PROFILE, null);
      if (!stored) return { ...DEFAULT_PROFILE };
      return { ...DEFAULT_PROFILE, ...stored };
    }

    let profileState = loadProfile();

    function populateForm() {
      const avatar = document.getElementById('profile-avatar');
      const username = document.getElementById('username');
      const badgeBoxes = document.querySelectorAll('.badge-box');

      avatar.src = profileState.photo || 'default-avatar.svg';
      avatar.classList.toggle('empty', !profileState.photo);
      username.value = profileState.name || '';

      const badges = Array.isArray(profileState.badges) && profileState.badges.length ? profileState.badges : DEFAULT_PROFILE.badges;
      badgeBoxes.forEach((box, idx) => {
        box.textContent = badges[idx] || '';
        box.classList.toggle('badge-box--active', badges[idx] === profileState.activeBadge);
      });
    }

    function getSelectedBadges() {
      return Array.from(document.querySelectorAll('.badge-box')).map(box => box.textContent.trim());
    }

    function getActiveBadge() {
      const active = document.querySelector('.badge-box.badge-box--active');
      if (active) return active.textContent.trim();
      const badges = getSelectedBadges().filter(Boolean);
      return badges[0] || DEFAULT_PROFILE.activeBadge;
    }

    function attachBadgeHandlers() {
      document.querySelectorAll('.badge-box').forEach(box => {
        box.addEventListener('click', () => {
          document.querySelectorAll('.badge-box').forEach(b => b.classList.remove('badge-box--active'));
          box.classList.add('badge-box--active');
        });
      });
    }

    async function compressImage(file) {
      const MAX_SIZE = 200;
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = event => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ratio = Math.min(1, MAX_SIZE / Math.max(img.width, img.height));
            canvas.width = Math.max(1, Math.round(img.width * ratio));
            canvas.height = Math.max(1, Math.round(img.height * ratio));
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL('image/jpeg', 0.7));
          };
          img.onerror = reject;
          img.src = event.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function handlePhotoChange(event) {
      const file = event.target.files[0];
      if (!file) return;
      try {
        const compressed = await compressImage(file);
        profileState.photo = compressed;
        const avatar = document.getElementById('profile-avatar');
        avatar.src = compressed;
        avatar.classList.remove('empty');
      } catch (error) {
        console.error('Gagal memproses gambar', error);
        alert('Gambar tidak dapat diproses. Coba gunakan gambar lain.');
      }
    }

    function resetProfile() {
      if (!confirm('Reset semua data profil?')) return;
      profileState = { ...DEFAULT_PROFILE };
      safeSetItem(STORAGE_KEYS.PROFILE, profileState);
      populateForm();
      alert('Profil telah direset.');
    }

    function saveProfile() {
      const usernameEl = document.getElementById('username');
      const nameInput = sanitizeText(usernameEl.value.trim());
      const name = nameInput || DEFAULT_PROFILE.name;
      const badges = getSelectedBadges();
      const activeBadge = getActiveBadge();

      const updated = {
        ...profileState,
        name,
        badges,
        activeBadge,
        updatedAt: new Date().toISOString()
      };

      profileState = updated;
      if (safeSetItem(STORAGE_KEYS.PROFILE, updated)) {
        alert('Profil disimpan!');
        window.location.href = 'profile.html';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelector('.edit-photo-label').addEventListener('click', () => document.getElementById('photo-input').click());
      document.getElementById('photo-input').addEventListener('change', handlePhotoChange);
      populateForm();
      attachBadgeHandlers();
      window.resetProfile = resetProfile;
      window.saveProfile = saveProfile;
    });
  </script>
</body>
</html>
